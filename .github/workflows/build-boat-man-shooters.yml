name: Build Boat Man Shooters (Nuitka)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
      fail-fast: false

    runs-on: ${{ matrix.os }}
    name: Build on ${{ matrix.os }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka

      - name: Build with Nuitka
        run: |
          cd "${{ github.workspace }}"

          # Base command (same entry point and data layout on all OSes)
          BASE_CMD="python -m nuitka \
            --standalone \
            --product-name='Boat Man Shooters' \
            --include-data-dir=Assets=Assets \
            --include-data-dir=Graphics=Graphics \
            --include-data-dir=Logos=Logos \
            --include-data-dir=Documentation=Documentation \
            --include-data-file='./Assets/DynaPuff Font/DynaPuffFont.ttf=Assets/DynaPuff Font/DynaPuffFont.ttf' \
            --output-dir=dist \
            Game_Code/main.py"

          if [ "${{ matrix.os }}" = "macos-latest" ]; then
            # Exact macOS flags from your local command
            ${BASE_CMD} \
              --macos-create-app-bundle \
              --macos-app-icon=MyIcon.icns \
              --macos-signed-app-name=com.apmckelvey.BoatManShooters
          elif [ "${{ matrix.os }}" = "windows-latest" ]; then
            # Windows single-file exe; icon optional if you add MyIcon.ico
            ${BASE_CMD} \
              --onefile \
              --windows-console-mode=disable \
              --windows-icon-from-ico=MyIcon.ico || ${BASE_CMD} --onefile --windows-console-mode=disable
          else
            # Linux standalone onefile binary; icon optional if you add MyIcon.png
            ${BASE_CMD} \
              --onefile \
              --linux-onefile-icon=MyIcon.png || ${BASE_CMD} --onefile
          fi

      - name: Show dist contents
        run: |
          cd "${{ github.workspace }}"
          ls -R dist || echo "dist not found"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: boat-man-shooters-${{ matrix.os }}
          path: dist/**
          if-no-files-found: error
